# Session Checkpoint

**Created**: 2026-02-22 13:30
**Branch**: 001-002-integration-test
**Working Directory**: d:\Source\GitHub\monocoque-agent-rc

## Task State

| # | Task | Status |
|---|------|--------|
| 1 | Resolve build targets | completed |
| 2 | Pre-flight: cargo check | completed |
| 3 | Phase 1: Register test modules | completed |
| 4 | Phase 1: Gates & commit | completed |
| 5 | Phase 1: Memory & compact | completed |
| 6 | Phase 2: Policy watcher tests | completed |
| 7 | Phase 2: Gates & commit | completed |
| 8 | Phase 2: Memory & compact | in-progress |
| 9 | Phase 3: IPC server tests | not-started |
| 10 | Phase 3: Gates & commit | not-started |
| 11 | Phase 3: Memory & compact | not-started |
| 12 | Phase 4: MCP dispatch tests | not-started |
| 13 | Phase 4: Gates & commit | not-started |
| 14 | Phase 4: Memory & compact | not-started |
| 15 | Phase 5: Polish & final gates | not-started |
| 16 | Phase 5: Memory & compact | not-started |

## Session Summary

Building spec `001-002-integration-test` in full mode. Phases 1 and 2 are complete.
Phase 1 registered 3 stub test modules. Phase 2 populated `policy_watcher_tests.rs`
with 6 integration tests covering FR-007 (S045–S050) — all 6 pass. Key discovery:
FR-011 command filtering strips commands not in global allowlist. Full suite: 487
tests, 0 failed. Phases 3–5 remain.

## Files Modified

| File | Change |
|------|--------|
| `tests/integration.rs` | Added 3 new module declarations |
| `tests/integration/policy_watcher_tests.rs` | 6 tests + helpers for FR-007 |
| `tests/integration/ipc_server_tests.rs` | Created empty stub (Phase 3 target) |
| `tests/integration/mcp_dispatch_tests.rs` | Created empty stub (Phase 4 target) |
| `specs/001-002-integration-test/tasks.md` | T001–T011 marked complete |
| `.copilot-tracking/memory/2026-02-22/001-002-integration-test-phase-1-memory.md` | Phase 1 memory |
| `.copilot-tracking/memory/2026-02-22/001-002-integration-test-phase-2-memory.md` | Phase 2 memory |

## Files in Context

- `specs/001-002-integration-test/tasks.md` — Phase task list (T001–T032)
- `tests/integration/policy_watcher_tests.rs` — Phase 2 completed tests
- `tests/integration/test_helpers.rs` — Shared infrastructure
- `src/policy/watcher.rs` — PolicyWatcher implementation
- `src/policy/loader.rs` — PolicyLoader (FR-011 command filtering)
- `src/models/policy.rs` — WorkspacePolicy model
- `src/ipc/server.rs` — IPC server (Phase 3 target, not yet read)
- `src/ipc/socket.rs` — IPC socket (Phase 3 target, not yet read)

## Key Decisions

1. `poll_until` helper uses 50ms sleep intervals with configurable ms timeout — matches spec requirement.
2. Global commands allowlist must include tested commands (FR-011 enforcement).
3. `cargo fmt` must be run before every commit — line width 100 reformats long generics.

## Failed Approaches

- T004 initially used `HashMap::new()` for `global_commands` — commands were stripped by FR-011.
  Fixed by passing the command in the allowlist.

## Open Questions

1. Does the IPC server expose a test-friendly `spawn` function with configurable pipe names?
2. Does `AppState` from `test_helpers.rs` include `pending_approvals` and `pending_waits` maps
   needed for approve/reject/resume IPC command tests?

## Next Steps

Phase 3 (T012–T021): populate `ipc_server_tests.rs`. Read `src/ipc/server.rs` first.

## Recovery Instructions

- This checkpoint: `.copilot-tracking/checkpoints/2026-02-22-1330-checkpoint.md`
- Phase 2 memory: `.copilot-tracking/memory/2026-02-22/001-002-integration-test-phase-2-memory.md`
- Task list: `specs/001-002-integration-test/tasks.md`
