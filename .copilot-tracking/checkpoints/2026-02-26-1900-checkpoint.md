# Session Checkpoint

**Created**: 2026-02-26 19:00
**Branch**: 004-intercom-advanced-features
**Working Directory**: D:\Source\GitHub\agent-intercom

## Task State

| # | Title | Status |
|---|-------|--------|
| 1 | Fix spawner URL (/sse → /mcp) | ✅ completed |
| 2 | Wire session_id through sse.rs factory | ✅ completed |
| 3 | Fix D1: rejection reason input UI | ✅ completed |
| 4 | Fix D4: FR-017 modal dismiss no-op | ✅ completed |
| 5 | Run quality gates | ✅ completed |
| 6 | cargo build + run-debug.ps1 | ✅ completed |

## Session Summary

HITL test suite was executed (16/20 PASS) and four defects were fixed. The spawner was broken because it pointed to `/sse?session_id=...` (which returns 410 Gone); it now points to `/mcp?session_id=...` with the session_id wired through the `PendingParams` slot in `sse.rs` so spawned agents associate with their pre-created DB session via `IntercomServer::with_overrides()`. The rejection path now opens a Slack modal to collect the operator's reason text before finalizing the rejection. Modal-opening actions no longer pre-emptively replace buttons with "Processing…", fixing the FR-017 dismiss-with-no-retry bug. All 687 tests pass, clippy and fmt are clean, the server compiled and is running healthy on `http://localhost:3000`.

## Files Modified

| File | Change |
|------|--------|
| `src/orchestrator/spawner.rs` | URL changed from `/sse?session_id=` to `/mcp?session_id=`; env var renamed `INTERCOM_SSE_URL` → `INTERCOM_MCP_URL` |
| `src/mcp/sse.rs` | `PendingParams` tuple now carries `(channel_id, session_id)`; factory uses `with_overrides()`; `extract_channel_id` renamed to `extract_query_param(uri, key)`; `update_pending_from_uri` helper extracted; new tests for `session_id` extraction |
| `src/mcp/handler.rs` | Added `use tokio::process::Child`; `ActiveChildren` type alias; `active_children: ActiveChildren` field on `AppState` |
| `src/main.rs` | Added `active_children: Arc::default()` to `AppState` initialization |
| `src/slack/commands.rs` | `handle_session_start`: `_child` → `child` stored in `active_children`; `handle_session_clear`: uses `state` instead of `db`, removes child from registry; `dispatch_command "session-clear"` passes `state`; `FULL_HELP` + `STEERING_HELP` added steer/task |
| `src/slack/events.rs` | Approval action handler call passes `trigger_id`; modal-opening actions skip pre-dispatch "Processing…" guard; `ViewClosed` arm cleans up `pending_modal_contexts` |
| `src/slack/handlers/approval.rs` | Added `SlackTriggerId` import; `trigger_id` parameter added; `approve_reject` action opens rejection-reason modal instead of hardcoding reason |
| `src/slack/handlers/modal.rs` | Added `ApprovalResponse`, `ApprovalStatus`, `ApprovalRepo` imports; `approval_reject` source handled; `resolve_approval_reject()` function added |
| `docs/REFERENCE.md` | Updated `INTERCOM_SSE_URL` → `INTERCOM_MCP_URL` in two places |
| `tests/integration/test_helpers.rs` | Added `active_children: Arc::default()` to both `AppState` builders |
| `tests/integration/channel_override_tests.rs` | Added `active_children: Arc::default()` (×2) |
| `tests/integration/health_endpoint_tests.rs` | Added `active_children: Arc::default()` (×1) |
| `tests/integration/mcp_dispatch_tests.rs` | Added `active_children: Arc::default()` (×1) |
| `tests/integration/handler_edge_case_tests.rs` | Added `active_children: Arc::default()` (×2) |
| `tests/integration/on_initialized_tests.rs` | Added `active_children: Arc::default()` (×2) |
| `tests/integration/disconnect_tests.rs` | Added `active_children: Arc::default()` (×3) |
| `tests/integration/ipc_server_tests.rs` | Added `active_children: Arc::default()` (×1) |
| `tests/integration/shutdown_tests.rs` | Added `active_children: Arc::default()` (×2) |
| `tests/integration/streamable_http_tests.rs` | Added `active_children: Arc::default()` (×1) |

## Files in Context

- `src/orchestrator/spawner.rs` — spawn_session, mcp_url fix
- `src/mcp/sse.rs` — PendingParams, ensure_accept_header, serve_with_listener, extract_query_param
- `src/mcp/handler.rs` — AppState struct, IntercomServer, with_overrides(), on_initialized(), session_id_override
- `src/main.rs` — AppState initialization
- `src/slack/commands.rs` — handle_session_start, handle_session_clear, FULL_HELP, STEERING_HELP
- `src/slack/events.rs` — handle_interaction, BlockActions dispatch, ViewClosed arm
- `src/slack/handlers/approval.rs` — handle_approval_action with trigger_id + modal
- `src/slack/handlers/modal.rs` — handle_view_submission, resolve_approval_reject
- `src/slack/handlers/prompt.rs` — handle_prompt_action (reference for modal pattern)
- `src/slack/handlers/wait.rs` — handle_wait_action (reference for modal pattern)
- `src/slack/blocks.rs` — instruction_modal() builder
- `src/slack/client.rs` — open_modal(), update_message()
- `tests/integration/test_helpers.rs` — test_app_state, test_app_state_with_db
- `docs/REFERENCE.md` — environment variable docs

## Key Decisions

1. **session_id via query param on /mcp**: The spawner passes `session_id` as a URL query param (`/mcp?session_id=<id>`). The `ensure_accept_header` middleware reads it and stores it in the `PendingParams` shared slot, which the rmcp factory closure reads when creating a new `IntercomServer`. This avoids needing any HTTP header manipulation by the host CLI.

2. **Rejection via modal (same pattern as Refine/Resume-with-Instructions)**: The `approve_reject` action uses `callback_id = "approval_reject:{request_id}"`, opens `instruction_modal()`, caches message context in `pending_modal_contexts`, and returns early from `handle_approval_action`. The `handle_view_submission` in `modal.rs` then routes `source = "approval_reject"` to `resolve_approval_reject()`.

3. **FR-017 fix is opt-out not opt-in**: Rather than adding a flag to every action, we check whether ANY action in the batch has an `action_id` that opens a modal (`wait_resume_instruct`, `prompt_refine`, `approve_reject`). If so, the pre-dispatch "Processing…" guard is skipped entirely. This is correct because Slack only sends one action per button click.

4. **`PendingParams` refactored**: Original `Arc<Mutex<Option<String>>>` (channel only) replaced with `Arc<Mutex<(Option<String>, Option<String>)>>` (channel + session). The `update_pending_from_uri` helper was extracted to keep `ensure_accept_header` within clippy's 100-line limit.

5. **`ActiveChildren` registry**: `AppState.active_children: Arc<Mutex<HashMap<String, Child>>>` stores live child processes keyed by session_id. `handle_session_start` inserts, `handle_session_clear` removes and terminates. This prevents Tokio from dropping (and killing) the child when the local binding goes out of scope.

## Failed Approaches

- **`extract_channel_id` renamed**: Initially tried to keep the old function and add a new one for session_id, but clippy correctly flagged the duplication. Replaced both with a single generic `extract_query_param(uri, key)`.
- **PendingParams inline in doc comment**: First refactor accidentally inserted the `type PendingParams` declaration inside the `ensure_accept_header` doc comment block, causing `doc-lazy-continuation` and `doc-list-item-without-indentation` clippy errors. Fixed by reordering declarations.

## Open Questions

- **host_cli_args in config.toml**: Currently `["--stdio"]`. `config.toml.example` suggests `["--sse"]` for Copilot CLI. Does the Copilot CLI accept the `INTERCOM_MCP_URL` env var and use it as the MCP endpoint? Or does it require a specific `--mcp-url` argument? This needs to be tested by running `/intercom session-start <prompt>` in Slack.
- **D7 (auto-approve suggestion)**: `suggestion_blocks()` in `command_approve.rs` is never called from the file approval path. Still a design gap — not yet wired.
- **S12/S13**: `/intercom steer` and `/intercom task` slash commands still not registered in the Slack App manifest (operator config issue, not code).

## Next Steps

1. **Test session-start end-to-end**: Run `/intercom session-start Hello world` in Slack. Verify the spawned process connects to `/mcp?session_id=<id>` and `on_initialized` logs "spawned agent connected to pre-created session".
2. **Verify rejection modal**: Run an agent tool call that triggers approval, press Reject, confirm a text input modal appears, type a reason, submit — verify the agent receives the rejection with the typed reason.
3. **Verify modal dismiss**: Open a modal (wait_resume_instruct or approve_reject), dismiss without submitting — verify buttons remain intact on the original Slack message.
4. **Commit all changes**: `git add` the modified files and commit with message `fix: spawner /mcp URL, rejection reason modal, FR-017 modal dismiss preserve buttons`.
5. **Wire D7 (auto-approve suggestion)**: After approving a file change in `approval.rs`, call `suggestion_blocks()` and post a follow-up Slack message.

## Recovery Instructions

To continue this session's work, read this checkpoint file and the following resources:

- This checkpoint: `.copilot-tracking/checkpoints/2026-02-26-1900-checkpoint.md`
- Constitution: `.github/instructions/constitution.instructions.md`
- Copilot instructions: `.github/copilot-instructions.md`
- Key source files: `src/mcp/sse.rs`, `src/mcp/handler.rs`, `src/orchestrator/spawner.rs`, `src/slack/handlers/approval.rs`, `src/slack/handlers/modal.rs`, `src/slack/events.rs`
