# Specification Quality Checklist: MCP Remote Agent Server (Deep)

**Purpose**: Exhaustive requirements quality validation across all user stories, functional requirements, edge cases, and success criteria — pre-planning gate for the spec author
**Created**: 2026-02-09
**Triaged**: 2026-02-11 — Rapid triage pass against spec, data-model, research, and contracts
**Feature**: [spec.md](../spec.md)

## Requirement Completeness

- [x] CHK001 - Are requirements defined for the primary agent's session creation and initial handshake when connecting via stdio transport? [Completeness, Gap] — **Resolved**: Clarifications 2026-02-10 defines multi-workspace with default_workspace_root. T031 auto-creates and activates a default session on first tool call for stdio-connected agents. Assumption §5 bounds to one primary stdio agent.
- [x] CHK002 - Are requirements specified for what happens when no workspace policy file (`.monocoque/settings.json`) exists at all? [Completeness, Gap] — **Resolved**: Edge Cases §6 ("workspace policy file is malformed → fallback to require approval for everything"). Research §9 confirms: absent file = deny-all default. T061 implements this.
- [x] CHK003 - Is a requirement defined for the initial operational mode at server startup? [Completeness, Gap] — **Resolved**: Data-model Session entity defines `mode` with default `"remote"`. Hardcoded default, not configurable per spec intent.
- [x] CHK004 - Are requirements defined for the `help` command's output when no custom registry commands are configured? [Completeness, Spec §FR-019] — **Resolved during implementation**: Help lists built-in commands; custom commands section is omitted when empty. Minor UX detail.
- [x] CHK005 - Are requirements specified for agent disconnection handling (stdio pipe closes, SSE connection drops)? [Completeness, Gap] — **Accepted gap, deferred to Phase 14**: Transport-level disconnect is handled by rmcp SDK (EOF on stdio, connection close on SSE). Session transitions to interrupted status. Stall timer stops.
- [x] CHK006 - Are requirements specified for the server's behavior when the SurrealDB embedded database file is corrupted or unreadable on startup? [Completeness, Gap] — **Accepted gap, deferred to Phase 14**: Server exits with AppError::Db on startup failure. No automatic recovery for v1. User deletes corrupted DB directory to reset.
- [x] CHK007 - Are requirements defined for maximum diff size limits passed to `ask_approval`? [Completeness, Gap] — **Resolved during implementation**: Slack file upload API handles large diffs (up to 1 GB). Inline rendering capped at 20 lines (Story 1 AS-1/AS-2). No explicit size limit needed for v1.
- [x] CHK008 - Are requirements specified for the `monocoque-ctl` local CLI binary's command surface and communication protocol? [Completeness, Gap] — **Resolved**: T088 defines the CLI commands: `list`, `approve <id>`, `reject <id> [--reason]`, `resume [instruction]`, `mode <remote|local|hybrid>`, `credential set <key>`. IPC protocol via interprocess named pipe/Unix socket.
- [x] CHK009 - Are multi-file diff requirements fully specified for `ask_approval` and `accept_diff`? [Completeness, Spec §FR-003/FR-005] — **Accepted partial coverage**: mcp-tools.json ask_approval `file_path` description says "additional paths extracted from unified diff headers." Multi-file acceptance scenarios deferred to Phase 14 polish.
- [x] CHK010 - Are requirements defined for concurrent `ask_approval` calls from the same session? [Completeness, Gap] — **Resolved**: Data-model ApprovalRequest validation rules state "only one pending approval request per session at a time (agent blocks until resolved)." Implementation returns error for concurrent calls.
- [x] CHK011 - Are requirements specified for the `wait_for_instruction` tool's interaction with stall detection? [Completeness, Gap] — **Resolved during implementation**: `wait_for_instruction` pauses stall timer (agent is intentionally idle). Timer resumes on resume signal. Logically consistent with FR-025.
- [x] CHK012 - Are requirements defined for log message ordering guarantees when multiple `remote_log` calls are made in rapid succession? [Completeness, Gap] — **Resolved by architecture**: Messages enqueued via tokio mpsc channel (FIFO), delivered in order by the rate-limited sender task. Ordering is guaranteed by the queue.
- [x] CHK013 - Are requirements specified for how the server handles Slack channel archival or deletion while running? [Completeness, Gap] — **Accepted gap, deferred to Phase 14**: Slack API returns channel_not_found error; mapped to AppError::Slack and logged. No auto-recovery for v1.

## Requirement Clarity

- [x] CHK014 - Is "small diff" quantified consistently across the spec? [Clarity, Spec §FR-003] — **Confirmed consistent**: Story 1 AS-1 says "fewer than 20 lines." Research §2 says "< 20 lines." No conflicting definitions in contracts or plan.
- [x] CHK015 - Is "configured timeout period" in Story 1 AS-5 traceable to a specific configuration key? [Clarity, Spec §US-1] — **Resolved**: data-model GlobalConfig.timeouts.approval_seconds (default 3600). Cross-reference is implicit but unambiguous from data-model and mcp-tools.json.
- [x] CHK016 - Is "within 5 seconds" in Story 1 AS-3 and Story 5 AS-2 a requirement on server processing time or end-to-end latency including Slack network round-trip? [Clarity, Spec §US-1/US-5] — **Accepted ambiguity**: Interpreted as server-side processing time (button press received → oneshot resolved → response returned to agent). Network latency is external and unmeasured.
- [x] CHK017 - Is the `risk_level` enum fully defined with clear criteria for when each level applies? [Clarity, Spec §FR-003] — **Resolved**: mcp-tools.json ask_approval defines risk_level as an agent-specified input parameter with default "low." The agent determines risk classification; the server routes based on the declared level.
- [x] CHK018 - Are the specific visual indicators for `remote_log` severity levels defined? [Clarity, Spec §FR-015] — **Resolved**: Research §2 and tasks T026/T055 define: info ℹ️, success ✅, warning ⚠️, error ❌. Block Kit builders implement these.
- [x] CHK019 - Is "wait state" for `session-pause` defined precisely? [Clarity, Spec §FR-012] — **Resolved during implementation**: Paused sessions reject tool calls with a descriptive error (not buffered). Agent receives error response and must wait for resume.
- [x] CHK020 - Is the "the session's original prompt" in the stall alert requirements clearly defined as always present? [Clarity, Spec §FR-026] — **Resolved**: data-model Session.prompt is `Option<String>`. When null, stall alert omits the prompt context section. Implementation detail.
- [x] CHK021 - Is "standard hardware" in SC-010 quantified with specific baseline specifications? [Clarity, Spec §SC-010] — **Accepted ambiguity**: Reasonable interpretation is a modern developer workstation (4+ cores, 8+ GB RAM, SSD). Not worth formalizing for v1 of a single-workstation tool.

## Requirement Consistency

- [x] CHK022 - Are the ApprovalRequest status values consistent between the Key Entities section and the data model? [Consistency, Spec §Key Entities] — **Resolved**: `interrupted` is an intentional addition in data-model for crash recovery (FR-021/US-9). Spec Key Entities lists the user-visible statuses; `interrupted` is an internal server-side state. No conflict.
- [x] CHK023 - Are Session status values consistent between the spec's Key Entities and the data model's state machine? [Consistency, Spec §Key Entities] — **Resolved**: Same rationale as CHK022. `interrupted` is an internal crash-recovery state added in data-model. Spec Key Entities correctly shows user-visible states.
- [x] CHK024 - Is the session owner binding behavior consistent between FR-013 and the edge case for "authorized user who is not the session owner"? [Consistency, Spec §FR-013] — **Confirmed compatible**: FR-013 says interactions are "rejected." Edge case says "logged but not treated as a security violation." These are complementary: rejection is the action, non-violation is the classification. No conflict.
- [x] CHK025 - Are timeout behaviors consistent across all blocking tools? [Consistency, Spec §FR-004/FR-008] — **Confirmed by design**: Each tool has intentionally different timeout semantics matching its use case. ask_approval → `timeout` (requires re-submission). forward_prompt → auto-`continue` (safe default). wait_for_instruction → configurable/indefinite. Consistent with operator expectations.
- [x] CHK026 - Is the auto-approve behavior for `forward_prompt` consistent with FR-032? [Consistency, Spec §FR-009/FR-032] — **Confirmed compatible**: FR-032 means tools are always *listed*. Auto-approve affects whether a tool's *action* requires Slack confirmation. These are orthogonal: visibility vs. authorization. No conflict.
- [x] CHK027 - Are the "first-response-wins" semantics in the Clarifications section consistent with FR-022's double-submission prevention? [Consistency, Spec §Clarifications/FR-022] — **Confirmed complementary**: FR-022 is UI-level prevention (replace buttons after first click). First-response-wins is server-level handling (oneshot channel resolves once). Defense in depth, not contradiction.

## Acceptance Criteria Quality

- [x] CHK028 - Can SC-001 ("under 30 seconds from notification arrival") be objectively measured given network variability? [Measurability, Spec §SC-001] — **Accepted**: Measured as elapsed time from Slack button press event receipt (server-side) to agent receiving tool response. Network latency to the operator's device is external.
- [x] CHK029 - Can SC-003 ("24-hour sessions, reconnecting within 5 minutes") be verified in a test environment? [Measurability, Spec §SC-003] — **Accepted**: Testable via integration test with mock network interruption. slack-morphism handles reconnection internally. Long-running stability is an operational concern, not a gate for implementation.
- [x] CHK030 - Can SC-012 ("80% of stall events") be verified without a statistically significant sample size? [Measurability, Spec §SC-012] — **Accepted**: For v1, verified qualitatively: auto-nudge fires → agent resumes within inactivity threshold = success. Formal statistical measurement deferred to production telemetry.
- [x] CHK031 - Is Story 7 AS-5 ("warns about file divergences") testable without specifying the warning format and confirmation mechanism? [Measurability, Spec §US-7] — **Resolved during implementation**: Slack message with diverged file list and Confirm/Cancel buttons per T071. UX detail resolved at implementation time.
- [x] CHK032 - Are the stall detection acceptance scenarios (Story 4 AS-1 through AS-10) independently testable without requiring a real stalled agent? [Measurability, Spec §US-4] — **Resolved**: Tests mock the stall condition by controlling the tokio timer directly. T110/T112 define the test approach: unit tests manipulate timer, integration tests simulate silence.

## Scenario Coverage

- [x] CHK033 - Are requirements defined for the server's behavior when Slack Socket Mode authentication fails on startup? [Coverage, Exception Flow, Gap] — **Resolved during implementation**: Server exits with AppError::Slack on authentication failure. Error message includes the failing token type. Implementation-obvious behavior.
- [x] CHK034 - Are requirements defined for the sequence: `ask_approval` → timeout → agent retries with same diff? [Coverage, Alternate Flow, Gap] — **Resolved during implementation**: Each ask_approval creates a new ApprovalRequest with a new request_id. The same diff can be resubmitted. Previous timed-out request stays in Expired status.
- [x] CHK035 - Are requirements defined for checkpoint restore when the referenced session is currently active (not terminated)? [Coverage, Alternate Flow, Spec §FR-012] — **Resolved**: data-model Checkpoint validation rules state "restoring a checkpoint terminates any currently active session for that session ID." Active session is terminated before restore.
- [x] CHK036 - Are requirements defined for `accept_diff` when the target file does not exist but the diff is a unified patch (not a full-file write)? [Coverage, Exception Flow, Gap] — **Resolved during implementation**: Unified diff against non-existent file returns AppError::Diff with descriptive message. Full-file write mode creates the file. T044/T107 cover this.
- [x] CHK037 - Are requirements defined for the `session-start` command when the configured `host_cli` binary is not found on PATH? [Coverage, Exception Flow, Gap] — **Resolved during implementation**: T068 spawner returns AppError::Config with "host CLI not found" when the binary is missing. Assumption §7 documents the prerequisite.
- [x] CHK038 - Are requirements defined for what happens when a spawned agent session (SSE transport) fails to connect back to the server? [Coverage, Exception Flow, Gap] — **Accepted gap, deferred to Phase 14**: Spawned process has a connection timeout (implementation default: 30s). On failure, session transitions to Terminated and Slack is notified.
- [x] CHK039 - Are requirements defined for operator actions on an expired/timed-out approval request? [Coverage, Alternate Flow, Gap] — **Resolved**: Timeout handler (T040) updates Slack message to replace buttons with "timed out" status text, same as FR-022 pattern. Operator sees static message, can't act.
- [x] CHK040 - Are recovery flow requirements defined for when `accept_diff` partially succeeds on a multi-file proposal (some files written, some fail)? [Coverage, Recovery Flow, Gap] — **Accepted gap, deferred to Phase 14**: v1 processes files sequentially; failure stops processing and returns error with list of successfully written files. No rollback for v1.

## Edge Case Coverage

- [x] CHK041 - Is behavior defined when the operator sends a Slack message to the channel that is not a slash command? [Edge Case, Gap] — **Resolved**: FR-018 exposes channel history as an MCP resource. Free-text messages are visible via the resource but not processed as commands. Only slash commands trigger server actions.
- [x] CHK042 - Is behavior defined when the `workspace_root` path does not exist at server startup? [Edge Case, Gap] — **Resolved**: config.rs validate() canonicalizes workspace_root and returns AppError::Config if the path doesn't exist. Already implemented.
- [x] CHK043 - Is behavior defined when `accept_diff` targets a path where the parent directory is read-only or permissions prevent writing? [Edge Case, Gap] — **Resolved during implementation**: IO error from tempfile::persist() or fs::create_dir_all() maps to AppError::Diff. Descriptive error returned to agent.
- [x] CHK044 - Is behavior defined for `session-checkpoint` when no files exist in the workspace? [Edge Case, Gap] — **Resolved**: Empty file_hashes map is valid. Checkpoint is created with an empty manifest. No special handling needed.
- [x] CHK045 - Is behavior defined when the Slack API returns an error for `chat.update` when dismissing a stall alert after self-recovery? [Edge Case, Gap] — **Resolved during implementation**: chat.update failure is logged as warning via tracing. Alert status is still updated in DB. Slack UI may show stale buttons but server state is correct.
- [x] CHK046 - Is behavior defined when two concurrent sessions both trigger stall alerts simultaneously? [Edge Case, Spec §Edge Cases] — **Resolved**: Edge Cases §13 explicitly covers this: "each session has its own independent stall timer. Alerts are posted with the session ID prominently displayed." Alerts are interleaved (not batched), rate-limited by the Slack message queue.
- [x] CHK047 - Is behavior defined when the agent calls `set_operational_mode("local")` but no IPC listener is active or `monocoque-ctl` is not installed? [Edge Case, Gap] — **Resolved during implementation**: Mode switch succeeds (it's a routing preference). If no IPC client connects, blocking tools time out normally. monocoque-ctl availability is not validated at mode-switch time.

## Non-Functional Requirements

- [x] CHK048 - Are memory consumption requirements defined beyond the stated constraint of "< 200 MB at steady state"? [NFR, Gap] — **Accepted**: Plan mentions < 200 MB as a monitoring target. Not formalized as a gate for v1. SurrealDB embedded + tokio runtime baseline is well under this.
- [x] CHK049 - Are logging/observability requirements defined for the server's own operational telemetry? [NFR, Gap] — **Resolved**: FR-037 defines structured tracing spans to stderr. Research §13 details span coverage. RUST_LOG env var controls verbosity. --log-format json flag for machine consumption. Already implemented in main.rs.
- [x] CHK050 - Are data retention requirements specified for the SurrealDB embedded database? [NFR, Gap] — **Resolved**: FR-035 defines 30-day auto-purge after session termination. data-model GlobalConfig.retention_days (default 30). T023 implements the retention service.
- [x] CHK051 - Are requirements specified for the server's CPU/resource usage during idle periods (no active sessions)? [NFR, Gap] — **Accepted**: Minimal footprint: tokio runtime idle, Slack WebSocket keep-alive (~1 ping/30s), no stall timers when no sessions active. Not worth formalizing for v1.
- [x] CHK052 - Are upgrade/migration requirements defined for the SurrealDB schema when the server version is updated? [NFR, Gap] — **Accepted**: Research §3 defines startup DDL with IF NOT EXISTS for idempotent migrations. Schema evolution across major versions is out of scope for v1.
- [x] CHK053 - Are requirements defined for the maximum number of historical sessions, checkpoints, and approval records the server must support? [NFR, Gap] — **Resolved**: Bounded by retention_days (default 30 days) via FR-035 auto-purge. With max 3 concurrent sessions, historical data volume is inherently small.

## Security Requirements

- [x] CHK054 - Are requirements defined for how Slack tokens (`app_token`, `bot_token`) are stored and protected? [Security, Gap] — **Resolved**: FR-036 defines OS keychain as primary, env vars as fallback. Research §10 details the keyring crate API. Plaintext config explicitly rejected by FR-036. T006 implements this.
- [x] CHK055 - Are requirements defined for command injection prevention beyond `shlex` escaping in the command dispatcher? [Security, Spec §FR-014] — **Resolved**: FR-014 is deny-by-default — only commands in the allowlist execute. Commands are pre-defined strings in config.toml, not user-composed. No shell interpolation of user input.
- [x] CHK056 - Are requirements defined for rate limiting on the MCP tool surface to prevent abuse by a malicious or misconfigured agent? [Security, Gap] — **Accepted gap, deferred to Phase 14**: v1 trusts connected agents (single-workstation deployment). Slack rate limiting (FR-020) bounds downstream impact. MCP-level rate limiting is a future enhancement.
- [x] CHK057 - Are requirements defined for the security boundary of the SSE/HTTP transport used by spawned sessions? [Security, Gap] — **Accepted**: Bound to 127.0.0.1 only (localhost). Single-workstation deployment model. No authentication for v1; network boundary is the security boundary.
- [x] CHK058 - Are the security logging requirements complete for all security-relevant events? [Security, Spec §Edge Cases] — **Resolved**: FR-037 tracing spans cover tool calls, Slack interactions, and session lifecycle. Research §13 explicitly lists path traversal attempts, policy evaluation decisions, and credential loading source. Implementation adds tracing spans per task.

## Dependencies and Assumptions

- [x] CHK059 - Is the assumption that "only one primary agent connects via stdio" validated with a requirement for what happens if two agents attempt stdio connections? [Assumption, Spec §Assumptions] — **Resolved**: stdio transport is a single process stdin/stdout stream — OS-level constraint prevents concurrent connections. Not a server-enforced limit.
- [x] CHK060 - Is the dependency on the `host_cli` binary versioned or compatibility-bounded? [Dependency, Spec §Assumptions] — **Accepted**: No version enforcement for v1. Assumption §7 documents the prerequisite. Host CLI compatibility testing is the operator's responsibility.
- [x] CHK061 - Is the dependency on Slack's Block Kit API versioned or documented? [Dependency, Gap] — **Accepted**: Slack API is backward-compatible by design. slack-morphism crate version (2.17) pins the SDK. No minimum Slack API version needed.
- [x] CHK062 - Is the assumption that MCP agents support server-to-client notifications validated? [Assumption, Spec §Clarifications] — **Resolved**: Research §5 documents the fallback: if custom notifications are dropped by stdio transport, fall back to notify_logging_message with structured nudge data.

## Ambiguities and Conflicts

- [x] CHK063 - Is the term "session state" in checkpoint requirements unambiguously defined? [Ambiguity, Spec §Key Entities] — **Resolved**: data-model Checkpoint.session_state is defined as `serde_json::Value` containing server-side session metadata (status, mode, prompt, nudge_count, etc.). Does NOT include agent in-memory context or conversation history. Boundary is clear from the data model.
- [x] CHK064 - Does "the agent resumes execution" (Story 4 AS-2) mean the agent acts on the nudge notification, or merely that the server sent the notification? [Ambiguity, Spec §US-4] — **Resolved**: Clarifications 2026-02-09 states nudge is delivered via MCP notification. Server guarantees delivery, not resumption. SC-012 (80% recovery) acknowledges not all nudges succeed. "Resumes execution" means the agent is expected to, but the server's obligation is delivery.
- [x] CHK065 - Are "spawned agent processes" in FR-021 limited to `session-start` processes, or does this include the primary stdio agent? [Ambiguity, Spec §FR-021] — **Resolved**: FR-021 scope is processes spawned by the server (session-start). The primary stdio agent is external (connected by the user, not spawned by the server). Server sends SIGTERM only to its own children. Stdio transport closure signals shutdown to the primary agent.
